<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Continuity Debugger</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        #debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background-color: #2F3136;
            color: #DCDDDE;
            border-top: 1px solid #4F545C;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            overflow-y: auto;
        }

        #debug-log {
            height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }

        .debug-entry {
            border-bottom: 1px solid #40444B;
            padding: 4px 0;
        }

        .debug-control {
            display: flex;
            gap: 8px;
        }

        .debug-button {
            background-color: #4F545C;
            color: #DCDDDE;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
        }

        .debug-button:hover {
            background-color: #5D6269;
        }
    </style>
</head>

<body>
    <h1>Message Continuity Debugger</h1>

    <div class="content">
        <div class="transcription-container">
            <h2>Transcription</h2>
            <div id="transcription-box" class="message-container"></div>
        </div>

        <div class="translation-container">
            <h2>Translation</h2>
            <div id="translations-container" class="message-container"></div>
        </div>
    </div>

    <div id="debug-panel">
        <h3>Debug Console</h3>
        <div id="debug-log"></div>
        <div class="debug-control">
            <button class="debug-button" id="clear-log">Clear Log</button>
            <button class="debug-button" id="test-message">Test Message</button>
            <button class="debug-button" id="inspect-history">Inspect History</button>
        </div>
    </div>

    <script>
        // Override console.log to also display in debug panel
        const originalConsoleLog = console.log;
        console.log = function (...args) {
            // Call original function
            originalConsoleLog.apply(console, args);

            // Add to debug panel
            const debugLog = document.getElementById('debug-log');
            const entry = document.createElement('div');
            entry.className = 'debug-entry';
            entry.textContent = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
            ).join(' ');
            debugLog.appendChild(entry);
            debugLog.scrollTop = debugLog.scrollHeight;
        };

        // Debug panel controls
        document.getElementById('clear-log').addEventListener('click', function () {
            document.getElementById('debug-log').innerHTML = '';
        });

        // Message simulation for testing
        document.getElementById('test-message').addEventListener('click', function () {
            const testUserId = '123456789';
            const testUserName = 'TestUser';

            // Simulate receiving messages
            handleMessageWithContinuity({
                user_id: testUserId,
                user: testUserName,
                text: "This is a test message.",
                timestamp: Date.now()
            }, Math.random() > 0.5 ? 'transcription' : 'translation');

            // After 2 seconds, simulate a follow-up message
            setTimeout(() => {
                handleMessageWithContinuity({
                    user_id: testUserId,
                    user: testUserName,
                    text: "This should be appended to the previous message.",
                    timestamp: Date.now()
                }, Math.random() > 0.5 ? 'transcription' : 'translation');
            }, 2000);
        });

        document.getElementById('inspect-history').addEventListener('click', function () {
            console.log("Current message history:", messageHistory);
        });

        // Initialize the rest of the script
        const DEBUG_MESSAGES = true;

        let messageHistory = {
            transcription: {},
            translation: {}
        };

        function handleMessageWithContinuity(messageData, messageType) {
            const userId = messageData.user_id;
            const userName = messageData.user;
            const text = messageData.text;
            const containerId = messageType === 'transcription' ? 'transcription-box' : 'translations-container';
            const container = document.getElementById(containerId);

            console.log(`Processing ${messageType} from ${userName} (${userId}): "${text}"`);

            // Initialize user history if this is first message
            if (!messageHistory[messageType][userId]) {
                messageHistory[messageType][userId] = {
                    lastMessageElement: null,
                    timestamp: 0
                };
            }

            const userHistory = messageHistory[messageType][userId];
            const now = Date.now();
            const messageTimeDiff = now - userHistory.timestamp;

            console.log(`Time since last message: ${messageTimeDiff}ms`);

            // Look for existing element from same user
            let shouldAppend = false;
            if (userHistory.lastMessageElement &&
                userHistory.lastMessageElement.parentNode === container &&
                messageTimeDiff < 10000) { // 10 seconds window for combining

                shouldAppend = true;
                console.log("âœ… COMBINING with previous message");
            } else {
                console.log("Creating NEW message element");
            }

            if (shouldAppend) {
                // Append to existing message
                const contentElement = userHistory.lastMessageElement.querySelector('.message-content');
                contentElement.textContent += " " + text;
            } else {
                // Create new message element
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.setAttribute('data-user-id', userId);
                messageElement.setAttribute('data-user', userName);

                const userElement = document.createElement('strong');
                userElement.textContent = userName + ": ";

                const contentElement = document.createElement('span');
                contentElement.className = 'message-content';
                contentElement.textContent = text;

                messageElement.appendChild(userElement);
                messageElement.appendChild(contentElement);
                container.appendChild(messageElement);

                // Update the user's history with this new element
                userHistory.lastMessageElement = messageElement;
            }

            // Update timestamp
            userHistory.timestamp = now;

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        console.log("Debug page loaded and ready for testing");
    </script>
</body>

</html>